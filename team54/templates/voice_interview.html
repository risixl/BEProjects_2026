<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voice Interview Assistant</title>

    <style>
        body {
            background: linear-gradient(to right, #d9a7c7, #fffcdc);
            font-family: "Poppins", sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 2rem;
            margin-top: 20px;
            color: #333;
        }

        .box {
            width: 70%;
            margin: 25px auto;
            background: white;
            padding: 25px;
            border-radius: 18px;
            box-shadow: 0 12px 25px rgba(0,0,0,0.12);
        }

        button {
            padding: 14px 30px;
            font-size: 17px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
        }

        .record-btn { background: #ff5252; color: white; }
        .stop-btn { background: #333; color: white; display: none; }

        #loader {
            font-size: 18px;
            color: #444;
            display: none;
            margin-top: 10px;
        }

        .result-block {
            margin-top: 20px;
            text-align: left;
        }

        .label { font-weight: bold; margin-top: 10px; }
        #emotion { font-size: 22px; font-weight: bold; color: #0077ff; }
    </style>
</head>

<body>

<h1>üé§ AI Voice Interview (5 Questions)</h1>

<div class="box">
    <h2 id="questionText">Tell me about yourself</h2>

    <button id="startBtn" class="record-btn">Start Recording</button>
    <button id="stopBtn" class="stop-btn">Stop Recording</button>

    <div id="loader">‚è≥ Processing... Please wait...</div>

    <div class="result-block">
        <p class="label">üìù Transcript:</p>
        <p id="transcript">---</p>

        <p class="label">‚ú® Improved English:</p>
        <p id="improved">---</p>

        <p class="label">üé≠ Emotion:</p>
        <p id="emotion">---</p>
    </div>
</div>

<script>
let audioContext, processor, input, stream;
let audioData = [];

// FIVE COMMON INTERVIEW QUESTIONS
const questions = [
    "Tell me about yourself.",
    "What are your strengths?",
    "Why should we hire you?",
    "Describe a difficult situation you handled.",
    "Where do you see yourself in 5 years?"
];

let qIndex = 0;

// Start Recording
document.getElementById("startBtn").onclick = async () => {
    audioData = [];
    document.getElementById("startBtn").style.display = "none";
    document.getElementById("stopBtn").style.display = "inline-block";

    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioContext = new AudioContext({ sampleRate: 16000 });
    input = audioContext.createMediaStreamSource(stream);

    processor = audioContext.createScriptProcessor(4096, 1, 1);
    processor.onaudioprocess = e => {
        audioData.push(new Float32Array(e.inputBuffer.getChannelData(0)));
    };

    input.connect(processor);
    processor.connect(audioContext.destination);
};

// Stop Recording
document.getElementById("stopBtn").onclick = async () => {
    processor.disconnect();
    input.disconnect();
    stream.getTracks().forEach(track => track.stop());

    document.getElementById("stopBtn").style.display = "none";
    document.getElementById("startBtn").style.display = "inline-block";

    document.getElementById("loader").style.display = "block";

    const wavBlob = exportWAV(audioData, audioContext.sampleRate);

    const formData = new FormData();
    formData.append("audio", wavBlob, "answer.wav");
    formData.append("question", questions[qIndex]);

    const response = await fetch("/voice_interview", {
        method: "POST",
        body: formData
    });

    const result = await response.json();

    document.getElementById("loader").style.display = "none";
    document.getElementById("transcript").innerText = result.transcript;
    document.getElementById("improved").innerText = result.improved;
    document.getElementById("emotion").innerText = result.emotion;

    // Save locally for graph
    storeLocal(result);

    qIndex++;

    if (qIndex < questions.length) {
        document.getElementById("questionText").innerText = questions[qIndex];
    } else {
        document.getElementById("questionText").innerText = "Interview Complete üéâ";
        document.getElementById("startBtn").style.display = "none";

        // Redirect to performance page after 3 sec
        setTimeout(() => {
            window.location.href = "/voice_performance";
        }, 2500);
    }
};

// Save performance in localStorage
function storeLocal(result) {
    const data = JSON.parse(localStorage.getItem("voicePerformance")) || [];
    data.push({
        question: questions[qIndex],
        emotion: result.emotion
    });
    localStorage.setItem("voicePerformance", JSON.stringify(data));
}

// WAV Export Helpers
function exportWAV(audioData, sampleRate) {
    const merged = mergeBuffers(audioData);
    const wavBuffer = encodeWAV(merged, sampleRate);
    return new Blob([wavBuffer], { type: "audio/wav" });
}
function mergeBuffers(buffers) {
    let length = buffers.reduce((acc, b) => acc + b.length, 0);
    const merged = new Float32Array(length);
    let offset = 0;
    buffers.forEach(b => { merged.set(b, offset); offset += b.length; });
    return merged;
}
function encodeWAV(samples, sampleRate) {
    const buffer = new ArrayBuffer(44 + samples.length * 2);
    const view = new DataView(buffer);
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + samples.length * 2, true);
    writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeString(view, 36, 'data');
    view.setUint32(40, samples.length * 2, true);
    floatTo16BitPCM(view, 44, samples);
    return buffer;
}
function floatTo16BitPCM(view, offset, samples) {
    samples.forEach((s, i) => {
        let t = Math.max(-1, Math.min(1, s));
        view.setInt16(offset + i * 2, t < 0 ? t * 0x8000 : t * 0x7FFF, true);
    });
}
function writeString(view, offset, string) {
    for (let i = 0; i < string.length; i++)
        view.setUint8(offset + i, string.charCodeAt(i));
}
</script>

</body>
</html>
